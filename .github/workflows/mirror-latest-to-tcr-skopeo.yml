name: Mirror Docker Hub latest to Tencent TCR (ALL skopeo)

on:
  schedule:
    - cron: "0 */6 * * *"   # 每 6 小时同步一次
  workflow_dispatch: {}     # 允许手动触发

concurrency:
  group: mirror-latest-to-tcr
  cancel-in-progress: false

jobs:
  mirror:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Install skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Mirror latest images via skopeo
        env:
          NS: ${{ secrets.TCR_NAMESPACE }}
          TCR_USER: ${{ secrets.TCR_USERNAME }}
          TCR_PASS: ${{ secrets.TCR_PASSWORD }}
        run: |
          set -euo pipefail

          mirror () {
            local src="$1"   # e.g. unclas/maimbot-adapter
            local dst="$2"   # e.g. maimbot-adapter
            local src_ref="docker://docker.io/${src}:latest"
            local dst_ref="docker://ccr.ccs.tencentyun.com/${NS}/${dst}:latest"

            echo "==== ${src_ref} -> ${dst_ref} ===="

            # registry-to-registry 复制；--all 尽量把 manifest list / 多架构一起搬过去
            for i in 1 2 3 4 5; do
              echo "Copy attempt $i..."
              if timeout 1800 skopeo copy --all \
                --dest-creds "${TCR_USER}:${TCR_PASS}" \
                "${src_ref}" "${dst_ref}"; then
                echo "OK"
                return 0
              fi
              echo "Retry in $((i*10))s..."
              sleep $((i*10))
            done

            echo "FAILED: ${dst_ref}"
            return 1
          }

          mirror unclas/maimbot-adapter maimbot-adapter
          mirror sengokucola/maibot maibot
          mirror mlikiowa/napcat-docker napcat-docker
          mirror coleifer/sqlite-web sqlite-web
          # 如果以后启用 chat2db，取消注释即可：
          # mirror chat2db/chat2db chat2db
